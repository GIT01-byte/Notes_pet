<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Заметки</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Стили для lightbox */
        #lightbox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        #lightbox img {
            max-width: 90%;
            max-height: 90%;
        }
    </style>
</head>
<body class="bg-slate-100">
    <div id="lightbox" onclick="closeLightbox()">
        <img src="" alt="Большое изображение" id="lightboxImage">
    </div>
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold text-center mb-8 text-slate-800">S3 Persistent Notes</h1>

        <!-- Регистрация -->
        <div class="bg-white shadow-md rounded-md p-4 mb-4">
            <h2 class="text-xl font-semibold mb-2">Регистрация</h2>
            <form id="registerForm">
                <div class="mb-2">
                    <label for="registerUsername" class="block text-sm font-medium text-gray-700">Имя пользователя:</label>
                    <input type="text" id="registerUsername" name="registerUsername" class="mt-1 p-2 w-full border rounded-md">
                </div>
                <div class="mb-2">
                    <label for="registerEmail" class="block text-sm font-medium text-gray-700">Email:</label>
                    <input type="email" id="registerEmail" name="registerEmail" class="mt-1 p-2 w-full border rounded-md">
                </div>
                <div class="mb-2">
                    <label for="registerPassword" class="block text-sm font-medium text-gray-700">Пароль:</label>
                    <input type="password" id="registerPassword" name="registerPassword" class="mt-1 p-2 w-full border rounded-md">
                </div>
                <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Зарегистрироваться</button>
            </form>
        </div>
        <!-- Логин -->
        <div class="bg-white shadow-md rounded-md p-4 mb-4">
            <h2 class="text-xl font-semibold mb-2">Логин</h2>
            <form id="loginForm">
                <div class="mb-2">
                    <label for="loginUsername" class="block text-sm font-medium text-gray-700">Имя пользователя:</label>
                    <input type="text" id="loginUsername" name="loginUsername" class="mt-1 p-2 w-full border rounded-md">
                </div>
                <div class="mb-2">
                    <label for="loginPassword" class="block text-sm font-medium text-gray-700">Пароль:</label>
                    <input type="password" id="loginPassword" name="loginPassword" class="mt-1 p-2 w-full border rounded-md">
                </div>
                <button type="submit" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Войти</button>
            </form>
        </div>

        <button id="getUserInfoBtn" class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded">Получить информацию о пользователе</button>
        <div id="userInfo" class="mt-4"></div>

        <!-- Форма для создания заметок -->
        <div class="bg-white shadow-md rounded-md p-4">
            <h2 class="text-xl font-semibold mb-2">Создать заметку</h2>
            <form id="noteForm">
                <div class="mb-2">
                    <label for="title" class="block text-sm font-medium text-gray-700">Заголовок:</label>
                    <input type="text" id="title" name="title" class="mt-1 p-2 w-full border rounded-md">
                </div>
                <div class="mb-2">
                    <label for="content" class="block text-sm font-medium text-gray-700">Содержание:</label>
                    <textarea id="content" name="content" rows="3" class="mt-1 p-2 w-full border rounded-md"></textarea>
                </div>

                <!-- Загрузка файлов -->
                <div class="mb-2">
                    <label class="block text-sm font-medium text-gray-700">Файлы:</label>
                    <input type="file" id="image_files" multiple accept="image/*">
                    <input type="file" id="video_files" multiple accept="video/*">
                    <input type="file" id="audio_files" multiple accept="audio/*">
                    <div id="image_files_queue"></div>
                    <div id="video_files_queue"></div>
                    <div id="audio_files_queue"></div>
                </div>

                <button id="submitBtn" type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Опубликовать Заметку</button>
            </form>
        </div>

        <!-- Список заметок -->
        <div id="notesList" class="mt-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:8080';

        let queue = { image_files: [], video_files: [], audio_files: [] };

        // --- LIGHTBOX ---
        function openLightbox(url) {
            document.getElementById('lightboxImage').src = url;
            document.getElementById('lightbox').style.display = 'flex';
        }

        function closeLightbox() {
            document.getElementById('lightbox').style.display = 'none';
        }
        function getCookie(name) {
            const value = localStorage.getItem(name);
            return value ? String(value) : undefined;
        }

        // --- FILE QUEUE ---
        ['video', 'image', 'audio'].forEach(type => {
            document.getElementById(`${type}_files`).onchange = (e) => {
                queue[`${type}_files`] = Array.from(e.target.files);
                renderQueue(`${type}_files`);
            };
        });

        const renderQueue = (target) => {
            let html = "";
            queue[target].forEach(file => {
                html += `<div class="inline-flex items-center space-x-2 bg-slate-200 px-3 py-1 rounded-full text-sm font-medium text-slate-700">Upload ${file.name}</div>`;
            });
            document.getElementById(`${target}_queue`).innerHTML = html;
        };

        // --- LOAD NOTES ---
        const loadNotes = async () => {
            const list = document.getElementById('notesList');
            list.innerHTML = "<h1>Загрузка...</h1>";

            try {
                const response = await fetch(`${API_BASE}/get_notes/`,{
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const notes = await response.json(); //исправлено из .text() в .json()

                list.innerHTML = ""; // очистка списка перед добавлением новых

                notes.forEach(n => {
                    const card = document.createElement('div');
                    card.classList.add('group', 'relative', 'bg-white', 'shadow-md', 'rounded-md', 'p-4');

                    const renderMedia = (title, urls, type) => {
                        if (!urls || urls.length === 0) return "";

                        let html = `<div class="mt-4"><h3 class="text-lg font-semibold text-slate-700">${title}</h3><div class="flex gap-4 mt-2 overflow-x-auto">`;
                        urls.forEach(url => {
                            const parts = url.split('/');
                            const name = parts.pop();
                            const dir = parts.join('/');

                            if (type === 'img') {
                                html += `<div class="text-center"><img src="${url}" onclick="openLightbox('${url}')" class="h-24 w-24 object-cover rounded-2xl border cursor-zoom-in hover:scale-105 transition shadow-sm">
                                            <p class="text-[7px] text-slate-400 mt-1 truncate w-24">${dir}/${name}</p></div>`;
                            } else if (type === 'video') {
                                html += `<div class="w-full"><video src="${url}" controls class="w-full rounded-2xl bg-slate-900"></video>
                                            <p class="text-[7px] text-slate-400 mt-1">${dir}/${name}</p></div>`;
                            } else if (type === 'audio') {
                                html += `<div class="w-full"><audio src="${url}" controls class="w-full"></audio>
                                            <p class="text-[7px] text-slate-400 mt-1">${dir}/${name}</p></div>`;
                            }
                        });
                        return html + "</div></div>";
                    };

                    card.innerHTML = `
                        <button onclick="deleteNote(${n.id})" class="absolute top-6 right-6 p-2 bg-red-50 text-red-500 rounded-full opacity-0 group-hover:opacity-100 transition-all hover:bg-red-500 hover:text-white shadow-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                        <h2 class="text-2xl font-black text-slate-800">${n.title}</h2>
                        <p class="text-slate-500 mt-1 font-medium text-sm italic">${n.content}</p>
                        ${renderMedia("Фотографии", n.image_urls, 'img')}
                        ${renderMedia("Видео файлы", n.video_urls, 'video')}
                        ${renderMedia("Аудио дорожки", n.audio_urls, 'audio')}
                        <div class="mt-6 pt-4 border-t border-slate-50 flex justify-between items-center text-[8px] font-bold text-slate-300 tracking-widest uppercase">
                            <span>S3 Persistent Record</span><span>ID: ${n.id}</span>
                        </div>
                    `;
                    list.appendChild(card);
                });
            } catch (err) {
                console.error(err);
            }
        }

        // --- SUBMIT ---
        document.getElementById('noteForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerText = "UPLOADING TO S3...";

            const url = new URL(`${API_BASE}/create/`);
            // Указываем тип контента как FormData
            const formData = new FormData();
            formData.append("title", document.getElementById('title').value);
            formData.append("content", document.getElementById('content').value);

            // Добавляем файлы из очереди
            Object.keys(queue).forEach(k => queue[k].forEach(f => formData.append(k, f)));

            try {
                const response = await fetch(url.toString(), {
                    method: 'POST',
                    body: formData, // Отправляем FormData
                });

                if (response.ok) {
                    document.getElementById('noteForm').reset();
                    Object.keys(queue).forEach(k => queue[k] = []);
                    ['video', 'image', 'audio'].forEach(t => renderQueue(`${t}_files`));
                    loadNotes();
                } else {
                    const errorData = await response.json();
                    alert(`Ошибка при создании заметки: ${errorData.detail || 'Неизвестная ошибка'}`);
                }
            } catch (err) {
                console.error(err);
                alert("Ошибка сети");
            } finally {
                btn.disabled = false;
                btn.innerText = "Опубликовать Заметку";
            }
        };

        // --- USER AUTHENTICATION ---
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('registerUsername').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;

            try {
                const response = await fetch(`${API_BASE}/user/register/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password }) // Отправляем JSON
                });

                if (response.ok) {
                    alert('Регистрация прошла успешно!');
                } else {
                    const errorData = await response.json();
                    alert(`Ошибка при регистрации: ${errorData.detail || 'Неизвестная ошибка'}`);
                }
            } catch (error) {
                console.error('Ошибка сети:', error);
                alert('Ошибка сети при регистрации.');
            }
        });

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const url = new URL(`${API_BASE}/user/login/`);
            // Указываем тип контента как FormData
            const formData = new FormData();
            formData.append("grant_type", "password");
            formData.append("username", document.getElementById('loginUsername').value);
            formData.append("password", document.getElementById('loginPassword').value);


            try {
                const response = await fetch(`${API_BASE}/user/login/`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    alert('Вход выполнен успешно!');
                    const loginData = await response.json();

                    if (loginData && loginData.access_token) {  // Проверяем наличие access_token
                        localStorage.setItem('access', loginData.access_token); // Сохраняем в localStorage
                        loadNotes(); // Загружаем заметки после успешного входа
                    } else {
                        console.error("Access token не получен в ответе:", loginData);
                        alert('Ошибка: Access token не получен от сервера.');
                    }
                
                } else {
                    const errorData = await response.json();
                    alert(`Ошибка при входе: ${errorData.detail || 'Неверные учетные данные'}`);
                }
            } catch (error) {
                console.error('Ошибка сети:', error);
                alert('Ошибка сети при входе.');
            }
        });

        document.getElementById('getUserInfoBtn').addEventListener('click', async () => {
            try {
                const access_cookie = getCookie("access");
                const response = await fetch(`${API_BASE}/user/self_info/`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${access_cookie}` }
                });

                if (response.ok) {
                    const userData = await response.json();
                    document.getElementById('userInfo').innerHTML = `<p>Имя пользователя: ${userData.username}</p><p>ID: ${userData.user_id}</p><p>Email: ${userData.email}</p>`;
                } else {
                    const errorData = await response.json();
                    alert(`Ошибка при получении информации о пользователе: ${errorData.detail || 'Не авторизован'}`);
                }
            } catch (error) {
                console.error('Ошибка сети:', error);
                alert('Ошибка сети при получении информации о пользователе.');
            }
        });

        loadNotes();
        window.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeLightbox(); });
    </script>
</body>
</html>
