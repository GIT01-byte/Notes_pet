<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NotesCloud Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .drop-zone { transition: all 0.3s ease; border: 2px dashed #cbd5e1; }
        .drop-zone.drag-over { background: #f1f5f9; border-color: #3b82f6; transform: scale(1.02); }
        .file-badge { display: flex; align-items: center; justify-content: space-between; background: #f8fafc; padding: 4px 10px; border-radius: 8px; border: 1px solid #e2e8f0; font-size: 0.75rem; margin-top: 4px; }
        #lightbox.active { display: flex; animation: fadeIn 0.2s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-20 font-sans text-slate-900">

    <!-- LIGHTBOX (–ü—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ) -->
    <div id="lightbox" class="fixed inset-0 bg-slate-950/90 backdrop-blur-md z-[100] hidden items-center justify-center p-4 cursor-zoom-out" onclick="closeLightbox()">
        <button class="absolute top-6 right-6 text-white text-4xl hover:text-red-400 transition">&times;</button>
        <img id="lightbox-img" src="" class="max-w-full max-h-full rounded-xl shadow-2xl transition-transform duration-300 scale-95">
    </div>

        <!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
        <div class="bg-white shadow-md rounded-md p-4 mb-4">
            <h2 class="text-xl font-semibold mb-2">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
            <form id="registerForm">
                <div class="mb-2">
                    <label for="registerUsername" class="block text-sm font-medium text-gray-700">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                    <input type="text" id="registerUsername" name="registerUsername" class="mt-1 p-2 w-full border rounded-md">
                </div>
                <div class="mb-2">
                    <label for="registerEmail" class="block text-sm font-medium text-gray-700">Email:</label>
                    <input type="email" id="registerEmail" name="registerEmail" class="mt-1 p-2 w-full border rounded-md">
                </div>
                <div class="mb-2">
                    <label for="registerPassword" class="block text-sm font-medium text-gray-700">–ü–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="registerPassword" name="registerPassword" class="mt-1 p-2 w-full border rounded-md">
                </div>
                <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            </form>
        </div>
        <!-- –õ–æ–≥–∏–Ω -->
        <div class="bg-white shadow-md rounded-md p-4 mb-4">
            <h2 class="text-xl font-semibold mb-2">–õ–æ–≥–∏–Ω</h2>
            <form id="loginForm">
                <div class="mb-2">
                    <label for="loginUsername" class="block text-sm font-medium text-gray-700">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                    <input type="text" id="loginUsername" name="loginUsername" class="mt-1 p-2 w-full border rounded-md">
                </div>
                <div class="mb-2">
                    <label for="loginPassword" class="block text-sm font-medium text-gray-700">–ü–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="loginPassword" name="loginPassword" class="mt-1 p-2 w-full border rounded-md">
                </div>
                <button type="submit" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">–í–æ–π—Ç–∏</button>
            </form>
        </div>

        <button id="getUserInfoBtn" class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded">–ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</button>
        <div id="userInfo" class="mt-4"></div>

    <div class="max-w-4xl mx-auto px-4 pt-10">
        <header class="text-center mb-10">
            <h1 class="text-5xl font-black tracking-tighter uppercase italic">Notes<span class="text-blue-600">Cloud</span></h1>
            <p class="text-slate-400 font-bold text-[10px] mt-2 tracking-[0.3em]">S3 AUTOMATION ‚Ä¢ DELETE SYNC ‚Ä¢ DRAG & DROP</p>
        </header>

        <!-- –§–û–†–ú–ê –°–û–ó–î–ê–ù–ò–Ø -->
        <div class="bg-white rounded-[2.5rem] shadow-2xl shadow-slate-200/50 p-8 mb-12 border border-slate-100">
            <form id="noteForm" class="space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-2 block">–ó–∞–≥–æ–ª–æ–≤–æ–∫ (Query)</label>
                        <input type="text" id="title" required placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ..." class="w-full bg-slate-50 border-none p-4 rounded-2xl focus:ring-2 focus:ring-blue-500 transition outline-none font-bold text-lg">
                    </div>
                    <div>
                        <label class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-2 block">–ö–æ–Ω—Ç–µ–Ω—Ç (Query)</label>
                        <input type="text" id="content" required placeholder="–û–ø–∏—Å–∞–Ω–∏–µ..." class="w-full bg-slate-50 border-none p-4 rounded-2xl focus:ring-2 focus:ring-blue-500 transition outline-none font-bold text-lg">
                    </div>
                </div>

                <!-- –ó–û–ù–´ –ó–ê–ì–†–£–ó–ö–ò -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="space-y-3">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">üé¨ –í–∏–¥–µ–æ</label>
                        <div id="drop-video" class="drop-zone rounded-3xl p-6 flex flex-col items-center justify-center cursor-pointer hover:bg-slate-50" onclick="document.getElementById('input-video').click()">
                            <span class="text-2xl mb-1">üìΩÔ∏è</span>
                            <span class="text-[9px] font-black text-slate-400 italic">ADD VIDEO</span>
                            <input type="file" id="input-video" multiple accept="video/*" class="hidden">
                        </div>
                        <div id="list-video"></div>
                    </div>

                    <div class="space-y-3">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">üñºÔ∏è –§–æ—Ç–æ</label>
                        <div id="drop-image" class="drop-zone rounded-3xl p-6 flex flex-col items-center justify-center cursor-pointer hover:bg-slate-50" onclick="document.getElementById('input-image').click()">
                            <span class="text-2xl mb-1">üì∏</span>
                            <span class="text-[9px] font-black text-slate-400 italic">ADD PHOTO</span>
                            <input type="file" id="input-image" multiple accept="image/*" class="hidden">
                        </div>
                        <div id="list-image"></div>
                    </div>

                    <div class="space-y-3">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">üéµ –ê—É–¥–∏–æ</label>
                        <div id="drop-audio" class="drop-zone rounded-3xl p-6 flex flex-col items-center justify-center cursor-pointer hover:bg-slate-50" onclick="document.getElementById('input-audio').click()">
                            <span class="text-2xl mb-1">üìª</span>
                            <span class="text-[9px] font-black text-slate-400 italic">ADD AUDIO</span>
                            <input type="file" id="input-audio" multiple accept="audio/*" class="hidden">
                        </div>
                        <div id="list-audio"></div>
                    </div>
                </div>

                <button type="submit" id="submitBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-black py-5 rounded-3xl transition shadow-xl shadow-blue-100 uppercase tracking-widest text-xs">
                    –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ó–∞–º–µ—Ç–∫—É
                </button>
            </form>
        </div>

        <div id="notesList" class="space-y-10"></div>
    </div>

    <script>
        const API_BASE = "http://127.0.0.1:8080";
        const queue = { video_files: [], image_files: [], audio_files: [] };

        // --- LIGHTBOX ---
        function openLightbox(url) {
            const lb = document.getElementById('lightbox');
            const img = document.getElementById('lightbox-img');
            img.src = url;
            lb.classList.remove('hidden'); lb.classList.add('active');
            setTimeout(() => img.style.transform = "scale(1)", 10);
            document.body.style.overflow = 'hidden';
        }
        function closeLightbox() {
            const lb = document.getElementById('lightbox');
            document.getElementById('lightbox-img').style.transform = "scale(0.95)";
            lb.classList.add('hidden'); lb.classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        // --- DROP ZONES ---
        const setupDropZone = (zoneId, inputId, type) => {
            const zone = document.getElementById(zoneId);
            const input = document.getElementById(inputId);
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => zone.addEventListener(e, (ev) => ev.preventDefault()));
            zone.addEventListener('dragover', () => zone.classList.add('drag-over'));
            zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
            zone.addEventListener('drop', (ev) => {
                zone.classList.remove('drag-over');
                handleFiles(ev.dataTransfer.files, type);
            });
            input.addEventListener('change', (ev) => {
                handleFiles(ev.target.files, type);
                input.value = "";
            });
        };

        const handleFiles = (files, type) => {
            Array.from(files).forEach(file => queue[type].push(file));
            renderQueue(type);
        };

        const renderQueue = (type) => {
            const container = document.getElementById(`list-${type.split('_')[0]}`);
            container.innerHTML = "";
            queue[type].forEach((file, idx) => {
                const item = document.createElement('div');
                item.className = "file-badge";
                item.innerHTML = `<span class="truncate pr-2">${file.name}</span>
                                 <button type="button" onclick="removeFromQueue('${type}', ${idx})" class="text-red-500 font-bold">√ó</button>`;
                container.appendChild(item);
            });
        };

        function removeFromQueue(type, index) {
            queue[type].splice(index, 1);
            renderQueue(type);
        }

        setupDropZone('drop-video', 'input-video', 'video_files');
        setupDropZone('drop-image', 'input-image', 'image_files');
        setupDropZone('drop-audio', 'input-audio', 'audio_files');

        // --- DELETE ---
        async function deleteNote(id) {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å –∑–∞–º–µ—Ç–∫—É #${id} –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ S3?`)) return;

            try {
                const response = await fetch(`${API_BASE}/notes/delete/${id}`, {
                    method: 'DELETE' // –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç–≤–æ–µ–º—É @router.delete
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log(result.msg);
                    loadNotes(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                } else {
                    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏");
                }
            } catch (err) { alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"); }
        }

        // --- RENDER ---
        async function loadNotes() {
            try {
                const res = await fetch(`${API_BASE}/notes/get_notes`);
                const responseData = await res.json(); // Parse the JSON response

                // Check if the 'data' field exists in the response
                if (!responseData.data) {
                    console.error("Error: 'data' field not found in API response:", responseData);
                    return; // Exit the function if 'data' is missing
                }

                const notes = responseData.data; // Access the 'data' array
                const list = document.getElementById('notesList');
                list.innerHTML = "";

                notes.reverse().forEach(n => {
                    const card = document.createElement('div');
                    card.className = "bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100 relative group transition-all hover:shadow-xl";

                    const renderMedia = (title, urls, type) => {
                        if (!urls?.length) return "";
                        let html = `<div class="mt-6"><h4 class="text-[9px] font-black text-slate-300 mb-3 tracking-[0.2em] uppercase">${title}</h4><div class="flex flex-wrap gap-4">`;
                        urls.forEach(url => {
                            const name = url.split('/').pop();
                            const dir = url.split('/').slice(-2, -1)[0];
                            if (type === 'img') {
                                html += `<div class="text-center"><img src="${url}" onclick="openLightbox('${url}')" class="h-24 w-24 object-cover rounded-2xl border cursor-zoom-in hover:scale-105 transition shadow-sm">
                                            <p class="text-[7px] text-slate-400 mt-1 truncate w-24">${dir}/${name}</p></div>`;
                            } else if (type === 'video') {
                                html += `<div class="w-full"><video src="${url}" controls class="w-full rounded-2xl bg-slate-900"></video>
                                            <p class="text-[7px] text-slate-400 mt-1">${dir}/${name}</p></div>`;
                            } else if (type === 'audio') {
                                html += `<div class="w-full"><audio src="${url}" controls class="w-full"></audio>
                                            <p class="text-[7px] text-slate-400 mt-1">${dir}/${name}</p></div>`;
                            }
                        });
                        return html + "</div></div>";
                    };

                    card.innerHTML = `
                        <button onclick="deleteNote(${n.id})" class="absolute top-6 right-6 p-2 bg-red-50 text-red-500 rounded-full opacity-0 group-hover:opacity-100 transition-all hover:bg-red-500 hover:text-white shadow-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                        <h2 class="text-2xl font-black text-slate-800">${n.title}</h2>
                        <p class="text-slate-500 mt-1 font-medium text-sm italic">${n.content}</p>
                        ${renderMedia("–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏", n.image_urls, 'img')}
                        ${renderMedia("–í–∏–¥–µ–æ —Ñ–∞–π–ª—ã", n.video_urls, 'video')}
                        ${renderMedia("–ê—É–¥–∏–æ –¥–æ—Ä–æ–∂–∫–∏", n.audio_urls, 'audio')}
                        <div class="mt-6 pt-4 border-t border-slate-50 flex justify-between items-center text-[8px] font-bold text-slate-300 tracking-widest uppercase">
                            <span>S3 Persistent Record</span><span>ID: ${n.id}</span>
                        </div>
                    `;
                    list.appendChild(card);
                });
            } catch (err) {
                console.error(err);
            }
        }

        // --- SUBMIT ---
        document.getElementById('noteForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.disabled = true; btn.innerText = "UPLOADING TO S3...";
            
            const url = new URL(`${API_BASE}/notes/create`);
            // –£–∫–∞–∑—ã–≤–∞–µ–º —Ç–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∫–∞–∫ FormData
            url.searchParams.append("title", document.getElementById('title').value);
            url.searchParams.append("content", document.getElementById('content').value);

            const formData = new FormData();
            Object.keys(queue).forEach(k => queue[k].forEach(f => formData.append(k, f)));

            try {
                const access_cookie = getCookie("access");
                const response = await fetch(url.toString(), {
                    method: 'POST', 
                    headers: { 'Autorization': `Bearer ${access_cookie}` },
                    body: formData 
                });
                if (response.ok) {
                    document.getElementById('noteForm').reset();
                    Object.keys(queue).forEach(k => queue[k] = []);
                    ['video', 'image', 'audio'].forEach(t => renderQueue(`${t}_files`));
                    loadNotes();
                }
            } catch (err) { alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"); }
            finally { btn.disabled = false; btn.innerText = "–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ó–∞–º–µ—Ç–∫—É"; }
        };

        // --- USER AUTHENTICATION ---
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('registerUsername').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;

            try {
                const response = await fetch(`${API_BASE}/user/register/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password }) // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º JSON
                });

                if (response.ok) {
                    alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!');
                } else {
                    const errorData = await response.json();
                    alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ${errorData.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error);
                alert(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ${error}`);
            }
        });

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const url = new URL(`${API_BASE}/user/login/`);
            // –£–∫–∞–∑—ã–≤–∞–µ–º —Ç–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∫–∞–∫ FormData
            const formData = new FormData();
            formData.append("grant_type", "password");
            formData.append("username", document.getElementById('loginUsername').value);
            formData.append("password", document.getElementById('loginPassword').value);


            try {
                const response = await fetch(`${API_BASE}/user/login/`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    alert('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
                    const loginData = await response.json();

                    if (loginData && loginData.access_token) {  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ access_token
                        localStorage.setItem('access', loginData.access_token); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                        loadNotes(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–º–µ—Ç–∫–∏ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—Ö–æ–¥–∞
                    } else {
                        console.error("Access token –Ω–µ –ø–æ–ª—É—á–µ–Ω –≤ –æ—Ç–≤–µ—Ç–µ:", loginData);
                        alert('–û—à–∏–±–∫–∞: Access token –Ω–µ –ø–æ–ª—É—á–µ–Ω –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞.');
                    }
                
                } else {
                    const errorData = await response.json();
                    alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ: ${errorData.detail || '–ù–µ–≤–µ—Ä–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ'}`);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error);
                alert(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –≤—Ö–æ–¥–µ: ${error}`);
            }
        });

        function getCookie(name) {
            const value = localStorage.getItem(name);
            return value ? String(value) : undefined; // –Ø–≤–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ —Å—Ç—Ä–æ–∫—É + –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ null
        }

        document.getElementById('getUserInfoBtn').addEventListener('click', async () => {
            try {
                const access_cookie = getCookie("access");
                const response = await fetch(`${API_BASE}/user/self_info/`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${access_cookie}` }
                });

                if (response.ok) {
                    const userData = await response.json();
                    document.getElementById('userInfo').innerHTML = `<p>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${userData.username}</p><p>ID: ${userData.user_id}</p><p>Email: ${userData.email}</p>`;
                } else {
                    const errorData = await response.json();
                    alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ: ${errorData.detail || '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω'}`);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error);
                alert(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ: ${error}`);
            }
        });

        loadNotes();
        window.addEventListener('keydown', (e) => { if(e.key === 'Escape') closeLightbox(); });
    </script>
</body>
</html>
